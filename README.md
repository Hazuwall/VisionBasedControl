# Vision-based control

Управление манипуляционным роботом в среде CoppeliaSim с использованием стереокамеры и обучения с подкреплением DDPG.

![Scene](/images/scene.png?raw=true)

## Алгоритм

**Цель агента** - приближение схвата к объекту определённого цвета, расположенного в рабочей зоне.<br/>
Для уменьшения количества входных признаков было решено предварительно извлекать из изображения параметры прямоугольника, обрамляющего целевой объект. Такое решение уменьшает привязанность к определённой камере и цели, предотвращает проблему с переносом программы на реальное устройство, где изображение значительно различается от моделируемого.<br/>
Для _детектирования_ в каждой точке находится расстояние L1 между цветом в ней и искомым. Далее по заданному порогу составляется маска принадлежности точек объекту, что позволяет найти прямоугольник, обрамляющий область.

![Detection](/images/detection.png?raw=true)

Перед непосредственным приближением к объекту происходит _поиск сектора_, из которого открывается вид на цель. Решение данной подзадачи предполагает сохранение промежуточных результатов и проще достигается императивно.<br/>
Таким образом, **нейросеть** производит планирование траектории по направлению к целевому объекту, находящемуся в зоне видимости. Вход нейронной сети - обобщённые координаты и параметры прямоугольной области, описывающей объект на изображении; выход - изменение координат.<br/>
Параметры нейросети настраиваются с помощью обучения с подкреплением по алгоритму DDPG (Deep Deterministic Policy Gradient). Алгоритм решает проблему непрерывности и многомерности действия агента.<br/>
Вычисляемая награда включает разницу потенциалов следующего и текущего состояний, а также штраф за длину перемещения. Предназначение штрафа в поощрении гладкой многоточечной траектории. Потенциал состояния вычисляется как взвешенная сумма площади прямоугольника, его смещения относительно центра изображения, а также средней дальности по карте глубины.

## Использование

1. Запустить симуляцию сцены _Scene.ttt_ в CoppeliaSim
2. Использовать ноутбук _inference.ipynb_

Необходимые библиотеки

- Tensorflow 2
- OpenCV
- Numpy

## Обучение

1. Запустить симуляцию статической сцены _StaticScene.ttt_ в CoppeliaSim. Использование статической модели робота в режиме синхронизации позволяет проводить обучение с максимальной скоростью.
2. Открыть скрипт _training&#46;py_ и настроить параметры обучения. Рекомендуется установить количество шагов обучения _steps_ >= 5000.
3. Выполнить скрипт

### Графики процесса обучения

Суммарная награда за эпизод

![Reward](/images/reward-per-ep.png?raw=true)

Оценка действий сети-актера Q

![Q-metric](/images/q-metric.png?raw=true)
